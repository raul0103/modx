# 1. –ü–µ—Ä–µ–Ω–æ—Å —Ñ–∞–π–ª–æ–≤

–ü–µ—Ä–µ–Ω–æ—Å–∏–º –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Ç—è–∂–µ–ª—ã—Ö —Ñ–∞–π–ª–æ–≤. –ü—Ä–∏–º–µ—Ä:

- ../public_html/assets/images
- ../public_html/assets/template/img/import
- ../public_html/assets/template/img/pdf-to-jpg
- ../public_html/assets/template/img/chertezhi
- ../public_html/assets/template/img/instruction

# 2. –ß–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ï—Å—Ç—å –µ—â–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–∂—ç–µ –º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å

## –†–µ—Å—É—Ä—Å—ã

–£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º

```sql
DELETE FROM modx_site_content WHERE context_key NOT IN ('tizol','beltep','baswool','xotpipe','isotecti','ruspanel')
```

–¢–æ–≤–∞—Ä—ã

```sql
DELETE FROM modx_ms2_products WHERE id NOT IN (SELECT id FROM modx_site_content)
```

TV

```sql
DELETE FROM modx_site_tmplvar_contentvalues WHERE contentid NOT IN (SELECT id FROM modx_site_content)
```

–û–ø—Ü–∏–∏

```sql
DELETE FROM modx_ms2_product_options WHERE product_id NOT IN (SELECT id FROM modx_site_content)
```

---

–û–ø—Ü–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π

```sql
DELETE FROM modx_ms2_category_options WHERE category_id NOT IN (SELECT id FROM modx_site_content)
```

Products INTRO

```sql
DELETE FROM modx_mse2_intro WHERE resource NOT IN (SELECT id FROM modx_site_content)
```

–ì–∞–ª–µ—Ä–µ–∏ —Ç–æ–≤–∞—Ä–æ–≤

```sql
DELETE FROM modx_ms2_product_files WHERE product_id NOT IN (SELECT id FROM modx_site_content)
```

---

## –ö–æ–Ω—Ç–µ–∫—Å—Ç—ã

**–í–∞–∂–Ω–æ:** _–Ω–µ —Ç—Ä–æ–≥–∞—Ç—å **mgr,web**!_

–õ–∏—à–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã

```sql
DELETE FROM modx_context WHERE `key` NOT IN ('web','mgr','tizol','beltep','baswool','xotpipe','isotecti','ruspanel')
```

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤

```sql
DELETE FROM modx_context_setting WHERE context_key NOT IN ('web','mgr','tizol','beltep','baswool','xotpipe','isotecti','ruspanel')
```

–†–∞–∑—Ä–µ—à–µ–Ω–∏—è

```sql
DELETE FROM modx_access_context WHERE `target` NOT IN ('web','mgr','tizol','beltep','baswool','xotpipe','isotecti','ruspanel')
```

# 3. –ó–∞–ª–∏–≤–∞–µ–º –Ω–∞ –±–æ–µ–≤–æ–π + –¥–æ–ª–∏–≤–∞–µ–º –¥–æ–ø —Ñ–∞–π–ª—ã –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞ 1–º —à–∞–≥–µ –Ω–µ —Å–∫–∞—á–∏–≤–∞–ª–∏

- ../public_html/\_import/
- ../public_html/assets/template/img/import
- ../public_html/assets/template/img/pdf-to-jpg
- ../public_html/assets/template/img/chertezhi
- ../public_html/assets/template/img/instruction

–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –±–∞–∑–µ –µ—Å–ª–∏ –µ—Å—Ç—å –¢–í –∏–ª–∏ –≤ –∫–æ–¥–µ –≤–∑–∞–∏–º–æ–¥–µ—Å—Ç–≤–∏–µ —Å —Ñ–∞–π–ª–∞–º–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–∞–ø–æ–∫, —Ç–æ –ø–∏—à–µ–º —Å–∫—Ä–∏–ø—Ç—ã –Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å –¢–û–õ–¨–ö–û –ù–£–ñ–ù–´–• –§–ê–ô–õ–û–í.

–ù–∞–ø—Ä–∏–º–µ—Ä –ø–æ—Å–ª–µ —á–∏—Å—Ç–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω–∞—è –ø–∞–ø–∫–∞ `../public_html/assets/template/img/chertezhi` –Ω–µ –Ω—É–∂–Ω–∞, —Ç–∞–∫ –∫–∞–∫ —Ä–µ—Å—É—Ä—Å—ã –∏ –∫–æ–¥ –µ–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç

```sql
SELECT * FROM modx_site_tmplvar_contentvalues WHERE `value` LIKE '%chertezhi%'
```

---

–ù–æ –µ—Å—Ç—å –ø–∞–ø–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–æ–ø–ª—å–∑—É—é—Ç—Å—è `- ../public_html/\_import/`
–ß–∞—Å—Ç–æ –æ—Ç —Ç—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –¢–í –ø–æ–ª–µ–π –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ `_import/files/img-tizol-06-05-24/tizol-lajt.jpg`

–í–æ–æ–±—â–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –±—Ä–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –ø–∞–ø–∫–∏ \_import - –û–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è
–ü–æ—ç—Ç–æ–º—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤—Å–µ—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫ —Å `_import/files` –Ω–∞–ø—Ä–∏–º–µ—Ä –≤ `assets/images/tv`

–¢–∞–∫ –∫–∞–∫ –æ–±—ã—á–Ω–æ —ç—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –≤–æ—Ç —Ä–∞–±–æ—á–∏–π —Å–∫—Ä–∏–ø—Ç:

```php
<?php

/**
 * –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ —É msCategory
 * - –±–µ—Ä—ë—Ç TV main_image
 * - –∫–∞—á–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É
 * - –∫–ª–∞–¥—ë—Ç –≤ /assets/images/categories/web/
 * - –æ–±–Ω–æ–≤–ª—è–µ—Ç TV –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø—É—Ç—ë–º
 */

$modx->getService('error', 'error.modError');
$modx->setLogLevel(modX::LOG_LEVEL_INFO);
$modx->setLogTarget('ECHO');

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏
$tvName = 'mainImage'; // –Ω–∞–∑–≤–∞–Ω–∏–µ –¢–í –ø–æ–ª—è –≤ –∫–æ—Ç–æ—Ä–æ–º —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –ø—É—Ç—å –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ
$baseUrl = 'https://minvata-78.ru/'; // –°–∞–π—Ç –æ—Ç –∫—É–¥–∞ –±—É–¥–µ–º –∫–∞—á–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏
$savePath = MODX_BASE_PATH . 'assets/images/categories/'; // –ü—É—Ç—å –∫—É–¥–∞ –∫–∞—á–∞–µ–º. –ë—É–¥–µ—Ç —Ä–∞–∑–±–∏–≤–∫–∞ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º

// –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ msCategory
$categories = $modx->getCollection('msCategory');
foreach ($categories as $cat) {
    $catId = $cat->get('id');
    $alias = $cat->get('alias');

    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ TV
    $tvValue = $cat->getTVValue($tvName);
    if (empty($tvValue)) {
        $modx->log(modX::LOG_LEVEL_INFO, "[$catId] –£ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç TV $tvName");
        continue;
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º URL –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ
    $imgUrl = $baseUrl . ltrim($tvValue, '/');
    $ext = pathinfo($imgUrl, PATHINFO_EXTENSION);
    if (!$ext) $ext = 'jpg';

    // –ò–º—è —Ñ–∞–π–ª–∞ = alias –∏–ª–∏ id
    $filename = $alias ? $alias . '.' . $ext : $catId . '.' . $ext;
    $contextPath = $savePath . '/' . $cat->context_key;

    // –°–æ–∑–¥–∞–¥–∏–º –ø–∞–ø–∫—É –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    if (!is_dir($contextPath)) {
        mkdir($contextPath, 0755, true);
    }

    // –ö–∞—á–∞–µ–º —Ñ–∞–π–ª
    $imgData = @file_get_contents($imgUrl);
    if ($imgData === false) {
        $modx->log(modX::LOG_LEVEL_ERROR, "[$catId] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å: $imgUrl");
        continue;
    }
    file_put_contents($contextPath . '/' . $filename, $imgData);

    // –ù–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è –¢–í
    $newTvPath = str_replace(MODX_BASE_PATH,'/', $contextPath . '/' . $filename);

    // –û–±–Ω–æ–≤–ª—è–µ–º TV
    $cat->setTVValue($tvName, $newTvPath);

    $modx->log(modX::LOG_LEVEL_INFO, "[$catId] –û–±–Ω–æ–≤–ª–µ–Ω–æ: $newTvPath");
}

$modx->log(modX::LOG_LEVEL_INFO, "–ì–æ—Ç–æ–≤–æ!");

```

# 4. –ì–∞–ª–µ—Ä–µ–∏ —Ç–æ–≤–∞—Ä–æ–≤

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–º–ø–æ—Ä—Ç–Ω—É—Ç—å –≥–∞–ª–µ—Ä–µ–∏

- ../public_html/assets/images

–ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏

```php
<?php

/**
 * –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–µ—Ç CSV —Ñ–∞–π–ª –≤ –∫–æ—Ä–Ω–µ —Å–∞–π—Ç–∞, —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ –æ–ø—Ü–∏—è–º —Ç–æ–≤–∞—Ä–æ–≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
 * –û–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–µ –¥—É–º–∞–ª, –Ω–∞–∫–∏–¥–∞–ª –Ω–∞ –∫–æ–ª–µ–Ω–∫–µ
 */

$limit = 5000;
$offset = 0;
$context_key = "metallprofil";
$domain = "www-knauf.ru";
$class_key = "msProduct";
$resources = []; // ID —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∫–∏, –µ—Å–ª–∏ –ø—É—Å—Ç–æ —Ç–æ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è
$table_prefix = $modx->getOption('table_prefix');

//> –ü–æ–¥–∫–ª—é—á–∞–µ–º MODX
// @include_once(dirname(dirname(__DIR__)) . '/config.core.php');
// @include_once(dirname(dirname(__DIR__)) . '/core/model/modx/modx.class.php');

// $modx = new modX();
// $modx->initialize('mgr');
//<



/**
 * –°–±–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤
 */
$query = $modx->newQuery('msProduct');
$query->limit($limit, $offset); // limit, offset
$where = [
    'context_key' => $context_key,
    'class_key' => $class_key,
];
if (!empty($resources)) {
    $where['id:in'] = $resources;
}
$query->where($where);
$products = $modx->getCollection('msProduct', $query);

$product_ids = []; // ID –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ –Ω–∏–º –∫–∞—Ä—Ç–∏–Ω–æ–∫

foreach ($products as $product) {
    $product_ids[] = $product->id;
}

/**
 * –°–±–æ—Ä –∫–∞—Ä—Ç–∏–Ω–æ–∫
 */
$images_result = $modx->query("
SELECT
    pf.url,
    sc.id
FROM
    {$table_prefix}ms2_product_files AS pf
LEFT JOIN {$table_prefix}site_content AS sc
ON
    sc.id = pf.product_id
WHERE
    pf.parent = 0 AND sc.id IN (" . implode(',', $product_ids) . ")");
$id_images = [];
while ($r = $images_result->fetch(PDO::FETCH_ASSOC)) {
    $id = $r['id'];
    if (empty($id_images[$id])) $id_images[$id] = [];
    $id_images[$id][] = $r['url'];
}

/**
 * –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
 */
$header_keys =  ['alias', 'parent'];

/**
 * –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
 */
$value_rows = "";
foreach ($products as $product) {
    $value_rows .= $product->alias . ';';
    $value_rows .= $product->parent . ';';

    // –ö–∞—Ä—Ç–∏–Ω–∫–∏
    $images = $id_images[$product->id];
    foreach ($images as $image_idx => $image) {
        $image_key = "image-$image_idx";
        if (!in_array($image_key, $header_keys)) {
            $header_keys[] = $image_key;
        }
        $value_rows .= "https://$domain/$image" . ';';
    }

    $value_rows .= PHP_EOL;
}

$header_keys = implode(';', $header_keys) . PHP_EOL;
$output = $header_keys . $value_rows;

/**
 * –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–∞–π–ª
 */
$filename = "images.csv";
$full_path = MODX_BASE_PATH . $filename;
file_put_contents($full_path, $output);

```

–ù–∞ –Ω–æ–≤–æ–º —Å–∞–π—Ç–µ - —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É \_import-images –≤ –Ω–µ–π —Ñ–∞–π–ª—ã –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞ –Ω–æ–≤—ã–π —Å–∞–π—Ç
–ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å —Ç–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ modx

```php
<?php

/**
 * –ò–º–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ miniShop2 –∏–∑ CSV (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
 */

header('Content-Type: text/html; charset=utf-8');
ini_set("max_execution_time", 0);

define('MODX_API_MODE', true);

$csvFile = MODX_BASE_PATH . '/_import-images/images.csv';
// $parent_dir = dirname(dirname(__FILE__)) . DIRECTORY_SEPARATOR;
// $index_php = $parent_dir . 'index.php';

// $i = 0;
// while (!file_exists($index_php) && $i < 9) {
//     $parent_dir = dirname(dirname($index_php)) . '/';
//     $index_php = $parent_dir . 'index.php';
//     $i++;
// }

// if (file_exists($index_php)) {
//     require_once $index_php;
// }

// if (!is_object($modx)) {
//     exit('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å MODX');
// }

if (!$minishop2 = $modx->getService('minishop2')) return;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function download_image($url, $save_path)
{
    $dir = dirname($save_path);
    if (!is_dir($dir)) {
        mkdir($dir, 0777, true);
    }

    $image_data = file_get_contents($url);
    if ($image_data === false) {
        echo "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: $url\n";
        return false;
    }

    file_put_contents($save_path, $image_data);
    return true;
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ CSV

$handle = fopen($csvFile, 'r');
if ($handle === false) {
    die("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–∞ $csvFile");
}

$images = [];

$header = fgetcsv($handle, 1000, ';'); // –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≥–æ–ª–æ–≤–æ–∫

while (($data = fgetcsv($handle, 1000, ';')) !== false) {
    $alias = $data[0];
    $parent = $data[1];

    $key = $alias.'-'.$parent;
    $images[$key] = [];

    for ($i = 2; $i < count($data); $i++) {
        $url = trim($data[$i]);
        if (!empty($url)) {
            $images[$key][] = $url;
        }
    }
}
fclose($handle);

$temp_images_dir = MODX_BASE_PATH . '/_import-images/temp_images/';
$log_file = MODX_BASE_PATH . '/_import-images/images.log';

$products = $modx->getIterator('modResource', [
    'class_key' => 'msProduct'
]);

foreach ($products as $product) {
    $key = $product->alias.'-'.$product->parent;

    if (isset($images[$key])) {
        foreach ($images[$key] as $image_url) {
            $path_parts = parse_url($image_url, PHP_URL_PATH);
            $file_name = basename($path_parts);
            $save_path = $temp_images_dir . $product->id . '/' . $file_name;

            if (download_image($image_url, $save_path)) {
                $message = $product->id . ' | ' . $product->alias . ' | ' . $product->parent . ' | ' . $file_name . "\n";
                echo $message;
                file_put_contents($log_file, $message, FILE_APPEND);

                $res = $minishop2->runProcessor('mgr/gallery/upload', [
                    'id' => $product->id,
                    'file' => $save_path
                ]);

                if ($res->isError()) {
                    file_put_contents($log_file, "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ miniShop2: " . print_r($res->getAllErrors(), true) . "\n", FILE_APPEND);
                }
            } else {
                $message = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: $image_url\n";
                echo $message;
                file_put_contents($log_file, $message, FILE_APPEND);
            }
        }
    }
}
```

---

# –ü—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –Ω–∞ –¥—Ä—É–≥—É—é –∞–¥–º–∏–Ω–∫—É —á–µ—Ä–µ–∑ CLONER

–ü–æ–ª—É—á–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ —Å–∞–π—Ç–∞

```php
<?php

// —Å–æ–∑–¥–∞—ë–º –∑–∞–ø—Ä–æ—Å
$query = $modx->newQuery('modResource');

// –≤—ã–±–∏—Ä–∞–µ–º ID —à–∞–±–ª–æ–Ω–∞ (template) –∏ –µ–≥–æ –∏–º—è (modTemplate.templatename)
$query->select([
    'modResource.template',
    'Template.templatename'
]);

// —Å–æ–µ–¥–∏–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É —à–∞–±–ª–æ–Ω–æ–≤
$query->leftJoin('modTemplate', 'Template', 'Template.id = modResource.template');

// —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
$query->where([
    'modResource.context_key' => 'zbi500',
]);

// —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ template ID
$query->groupby('modResource.template');

// –≤—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
$query->prepare();
$query->stmt->execute();

// –ø–æ–ª—É—á–∞–µ–º –ø–∞—Ä—ã ID => –ù–∞–∑–≤–∞–Ω–∏–µ
$rows = $query->stmt->fetchAll(PDO::FETCH_ASSOC);

$result = [];
foreach ($rows as $row) {
    $result[$row['template']] = $row['templatename'];
}

print_r($result);

```

–ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –º–æ–≥—É—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞—Ç—å—Å—è –≤—Å–µ –æ–ø—Ü–∏–∏. –ü–æ—ç—Ç–æ–º—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ

1. –ü–æ–ª—É—á–∏—Ç—å —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–∞

```sql
SELECT mo.`key` AS option_key,msc.alias AS category_alias,mco.`rank` FROM modx_ms2_category_options AS mco
JOIN modx_ms2_options AS mo ON mo.id = mco.option_id
JOIN modx_site_content AS msc ON msc.id = mco.category_id
WHERE category_id IN (SELECT id FROM modx_site_content WHERE context_key = 'zbi500')
```

2. –ú–∞—Å—Å–∏–≤–æ–º PHP –ø—Ä–æ–≥–Ω–∞—Ç—å –Ω–∞ –Ω–æ–≤–æ–º —Å–∞–π—Ç–µ

```php
<?php

$items = [
  [
    'option_key' => 'razmer',
    'category_alias' => 'bruschatka-trotuarnaya',
    'rank' => 19,
  ],
  [
    'option_key' => 'obyem_m3',
    'category_alias' => 'aehrodromnye-plity',
    'rank' => 15,
  ],
  [
    'option_key' => 'obyem_m3',
    'category_alias' => 'plityi-dorozhnyie-2p',
    'rank' => 17,
  ],
  [
    'option_key' => 'obyem_m3',
    'category_alias' => 'plity-dorozhnye-1p',
    'rank' => 18,
  ],
];

foreach ($items as $item) {

  $option = $modx->getObject('msOption', [
    'key' => $item['option_key']
  ]);

  $category = $modx->getObject('modResource', [
    'alias' => $item['category_alias']
  ]);

  if (!$option || !$category) {
    echo "not found: {$item['option_key']} / {$item['category_alias']}" . PHP_EOL;
    continue;
  }

  $insertData = [
    'option_id'   => $option->get('id'),
    'category_id' => $category->get('id'),
    'rank'        => $item['rank'],
  ];

  $sql = "
    INSERT INTO modx_ms2_category_options
    (option_id, category_id, `rank`, active, required,value)
    VALUES (:option_id, :category_id, :rank, 1, 0, '')
  ";

  $stmt = $modx->prepare($sql);
  $result = $stmt->execute($insertData);

  if ($result) {
    echo "success: {$item['option_key']} -> {$item['category_alias']}" . PHP_EOL;
  } else {
    $errorInfo = $stmt->errorInfo();
    echo "error: " . print_r($errorInfo, true) . PHP_EOL;
  }
}

echo "done";

```

### –î–∞–Ω–Ω—ã–µ –¥–ª—è msProductsComposerSelection –∏ modx_ss_rules

–° –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ —Å–∞–π—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–æ–≤—ã–π –≤—Å—é —Ç–∞–±–ª–∏—Ü—É modx_products_composer_selection

#### üü¢ –°–ö–†–ò–ü–¢ 1 ‚Äî –î–û–ùO–†

–ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ –¥–æ–Ω–æ—Ä–µ

```php
 <?php
  /**
  * DONOR SCRIPT
  * –°–æ–±–∏—Ä–∞–µ—Ç:
  * 1. rid ‚Üí alias
  * 2. parent IDs ‚Üí alias
  */

  $context = 'fasad';
  $file = MODX_BASE_PATH . 'ms_products_composer_map.json';

  /* =========================
  * RID (msCategory)
  * ========================= */
  $categories = $modx->getCollection('modResource', [
      'context_key' => $context,
      'class_key'   => 'msCategory'
  ]);

  $rid = [];
  foreach ($categories as $cat) {
      $rid[$cat->id] = $cat->alias;
  }

  /* =========================
  * PARENT
  * ========================= */
  $res = $modx->query("
      SELECT val
      FROM modx_products_composer_selection
      WHERE `key` = 'parent'
  ");

  $parentsIds = [];
  foreach ($res->fetchAll(PDO::FETCH_ASSOC) as $row) {
      $parentsIds = array_merge($parentsIds, explode(',', $row['val']));
  }

  $parentsIds = array_unique(array_filter($parentsIds));

  $parentsResources = $modx->getCollection('modResource', [
      'id:in' => $parentsIds
  ]);

  $parents = [];
  foreach ($parentsResources as $res) {
      $parents[$res->id] = $res->alias;
  }

  /* =========================
  * SAVE
  * ========================= */
  $data = [
      'rid'    => $rid,
      'parent' => $parents
  ];

  file_put_contents($file, json_encode($data, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));

  echo 'DONOR: success';

```

#### üîµ –°–ö–†–ò–ü–¢ 2 ‚Äî –ù–û–í–´–ô –°–ê–ô–¢

–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤–æ–º —Å–∞–π—Ç–µ

```php
<?php
/**
 * TARGET SCRIPT
 * –û–±–Ω–æ–≤–ª—è–µ—Ç:
 * 1. rid
 * 2. parent
 */

$file = MODX_BASE_PATH . 'ms_products_composer_map.json';
$data = json_decode(file_get_contents($file), true);

if (!$data) {
    exit('JSON not found or invalid');
}

/* =========================
 * UPDATE RID
 * ========================= */
foreach ($data['rid'] as $oldId => $alias) {

    $resource = $modx->getObject('modResource', ['alias' => $alias]);
    if (!$resource) {
        continue;
    }

    $newId = $resource->id;

    $modx->query("
        UPDATE modx_products_composer_selection
        SET rid = {$newId}
        WHERE rid = {$oldId}
    ");
}

/* =========================
 * UPDATE PARENT
 * ========================= */
$res = $modx->query("
    SELECT id, val
    FROM modx_products_composer_selection
    WHERE `key` = 'parent'
");

$rows = $res->fetchAll(PDO::FETCH_ASSOC);

foreach ($rows as $row) {

    $parents = explode(',', $row['val']);
    $newParents = [];

    foreach ($parents as $oldParentId) {

        if (!isset($data['parent'][$oldParentId])) {
            continue;
        }

        $alias = $data['parent'][$oldParentId];
        $resource = $modx->getObject('modResource', ['alias' => $alias]);

        if ($resource) {
            $newParents[] = $resource->id;
        }
    }

    if (!empty($newParents)) {
        $ids = implode(',', array_unique($newParents));

        $modx->query("
            UPDATE modx_products_composer_selection
            SET val = '{$ids}'
            WHERE id = {$row['id']}
        ");
    }
}

echo 'TARGET: success';
```

#### üîµ –°–ö–†–ò–ü–¢ 3 - –ù–û–í–´–ô –°–ê–ô–¢

–î–∞–Ω–Ω—ã–µ –¥–ª—è modx_ss_rules - –ü–ª–∞–≥–∏–Ω –∫–æ—Ç–æ—Ä—ã–π –≤ —Ç–æ–≤–∞—Ä–µ –≤—ã–≤–æ–¥–∏—Ç "–í–∞–º –º–æ–≥—É—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è" —Ç–∞–±–∞–º–∏

```php
<?php
/**
 * UPDATE modx_ss_rules.categories
 * old_id ‚Üí alias ‚Üí new_id
 */

$file = MODX_BASE_PATH . 'ms_products_composer_map.json';
$data = json_decode(file_get_contents($file), true);

if (!$data || empty($data['rid'])) {
    exit('Mapping file not found or invalid');
}

/* =========================
 * LOAD RULES
 * ========================= */
$res = $modx->query("
    SELECT id, categories
    FROM modx_ss_rules
    WHERE categories IS NOT NULL
      AND categories != ''
");

$rows = $res->fetchAll(PDO::FETCH_ASSOC);

/* =========================
 * UPDATE
 * ========================= */
foreach ($rows as $row) {

    $oldIds = explode(',', $row['categories']);
    $newIds = [];

    foreach ($oldIds as $oldId) {
        $oldId = trim($oldId);

        // old_id ‚Üí alias
        if (!isset($data['rid'][$oldId])) {
            continue;
        }

        $alias = $data['rid'][$oldId];

        // alias ‚Üí new_id
        $resource = $modx->getObject('modResource', ['alias' => $alias]);
        if ($resource) {
            $newIds[] = $resource->id;
        }
    }

    if (!empty($newIds)) {

        $newIds = implode(',', array_unique($newIds));

        $modx->query("
            UPDATE modx_ss_rules
            SET categories = '{$newIds}'
            WHERE id = {$row['id']}
        ");
    }
}

echo 'SS RULES: success';
```

# –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
  - –§–æ—Ä–º—ã
  - robots
  - sitemap.xml
  - –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
