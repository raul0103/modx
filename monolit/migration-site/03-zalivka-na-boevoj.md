# 3. –ó–∞–ª–∏–≤–∫–∞ –Ω–∞ –±–æ–µ–≤–æ–π —Å–µ—Ä–≤–µ—Ä + –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–ª–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω—ã –Ω–∞ –ø–µ—Ä–≤–æ–º —ç—Ç–∞–ø–µ.

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –ü–µ—Ä–µ–¥ –ø–µ—Ä–µ–Ω–æ—Å–æ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ –æ–Ω–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∫–æ–¥–µ. –ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç–µ –Ω–µ–Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã!

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞

- `../public_html/_import/`
- `../public_html/assets/template/img/import`
- `../public_html/assets/template/img/pdf-to-jpg`
- `../public_html/assets/template/img/chertezhi`
- `../public_html/assets/template/img/instruction`

## ‚ö†Ô∏è –í–∞–∂–Ω–æ: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤

–ü–µ—Ä–µ–¥ –ø–µ—Ä–µ–Ω–æ—Å–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏ —Ñ–∞–π–ª—ã –∏–∑ —ç—Ç–∏—Ö –ø–∞–ø–æ–∫ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∫–æ–¥–µ.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ SQL

–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Ñ–∞–π–ª—ã –≤ TV-–ø–æ–ª—è—Ö:

```sql
SELECT * FROM modx_site_tmplvar_contentvalues WHERE `value` LIKE '%chertezhi%'
```

> üí° **–ü—Ä–∏–º–µ—Ä:** –ü–æ—Å–ª–µ —á–∏—Å—Ç–∫–∏ –±–∞–∑—ã –ø–∞–ø–∫–∞ `../public_html/assets/template/img/chertezhi` –º–æ–∂–µ—Ç –æ–∫–∞–∑–∞—Ç—å—Å—è –Ω–µ –Ω—É–∂–Ω–∞, —Ç–∞–∫ –∫–∞–∫ —Ä–µ—Å—É—Ä—Å—ã –∏ –∫–æ–¥ –µ—ë –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç.

## –ü–µ—Ä–µ–Ω–æ—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ _import

> ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞:** –ß–∞—Å—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–µ—Ä—É—Ç—Å—è –∏–∑ –ø–∞–ø–∫–∏ `_import`, —á—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞.

**–ü—Ä–∏–º–µ—Ä –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø—É—Ç–∏:** `_import/files/img-tizol-06-05-24/tizol-lajt.jpg`

### –†–µ—à–µ–Ω–∏–µ

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –≤—Å–µ—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏–∑ `_import/files` –≤ –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä `assets/images/tv` –∏–ª–∏ `assets/images/categories`.

> üí° **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–±–Ω–æ–≤–∏—Ç–µ –ø—É—Ç–∏ –≤ TV-–ø–æ–ª—è—Ö, —á—Ç–æ–±—ã –æ–Ω–∏ —É–∫–∞–∑—ã–≤–∞–ª–∏ –Ω–∞ –Ω–æ–≤—ã–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.

### –°–∫—Ä–∏–ø—Ç –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π

–°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ —É msCategory:

<details>
<summary>–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</summary>

```php
<?php

/**
 * –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ —É msCategory
 * - –±–µ—Ä—ë—Ç TV main_image
 * - –∫–∞—á–∞–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫—É
 * - –∫–ª–∞–¥—ë—Ç –≤ /assets/images/categories/web/
 * - –æ–±–Ω–æ–≤–ª—è–µ—Ç TV –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø—É—Ç—ë–º
 */

$modx->getService('error', 'error.modError');
$modx->setLogLevel(modX::LOG_LEVEL_INFO);
$modx->setLogTarget('ECHO');

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏
$tvName = 'mainImage'; // –Ω–∞–∑–≤–∞–Ω–∏–µ –¢–í –ø–æ–ª—è –≤ –∫–æ—Ç–æ—Ä–æ–º —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –ø—É—Ç—å –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ
$baseUrl = 'https://minvata-78.ru/'; // –°–∞–π—Ç –æ—Ç –∫—É–¥–∞ –±—É–¥–µ–º –∫–∞—á–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∏
$savePath = MODX_BASE_PATH . 'assets/images/categories/'; // –ü—É—Ç—å –∫—É–¥–∞ –∫–∞—á–∞–µ–º. –ë—É–¥–µ—Ç —Ä–∞–∑–±–∏–≤–∫–∞ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º

// –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ msCategory
$categories = $modx->getCollection('msCategory');
foreach ($categories as $cat) {
    $catId = $cat->get('id');
    $alias = $cat->get('alias');

    // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ TV
    $tvValue = $cat->getTVValue($tvName);
    if (empty($tvValue)) {
        $modx->log(modX::LOG_LEVEL_INFO, "[$catId] –£ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç TV $tvName");
        continue;
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º URL –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ
    $imgUrl = $baseUrl . ltrim($tvValue, '/');
    $ext = pathinfo($imgUrl, PATHINFO_EXTENSION);
    if (!$ext) $ext = 'jpg';

    // –ò–º—è —Ñ–∞–π–ª–∞ = alias –∏–ª–∏ id
    $filename = $alias ? $alias . '.' . $ext : $catId . '.' . $ext;
    $contextPath = $savePath . '/' . $cat->context_key;

    // –°–æ–∑–¥–∞–¥–∏–º –ø–∞–ø–∫—É –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    if (!is_dir($contextPath)) {
        mkdir($contextPath, 0755, true);
    }

    // –ö–∞—á–∞–µ–º —Ñ–∞–π–ª
    $imgData = @file_get_contents($imgUrl);
    if ($imgData === false) {
        $modx->log(modX::LOG_LEVEL_ERROR, "[$catId] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å: $imgUrl");
        continue;
    }
    file_put_contents($contextPath . '/' . $filename, $imgData);

    // –ù–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è –¢–í
    $newTvPath = str_replace(MODX_BASE_PATH,'/', $contextPath . '/' . $filename);

    // –û–±–Ω–æ–≤–ª—è–µ–º TV
    $cat->setTVValue($tvName, $newTvPath);

    $modx->log(modX::LOG_LEVEL_INFO, "[$catId] –û–±–Ω–æ–≤–ª–µ–Ω–æ: $newTvPath");
}

$modx->log(modX::LOG_LEVEL_INFO, "–ì–æ—Ç–æ–≤–æ!");

```

</details>

## –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

### üü¢ –°–ö–†–ò–ü–¢ 1 ‚Äî –î–û–ù–û–†

–°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ MIGX-TV "certs" —É —Ç–æ–≤–∞—Ä–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ "fasad".

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** JSON-—Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π.

<details>
<summary>–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</summary>

```php
<?php

/**
 * –°–±–æ—Ä –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ MIGX-TV "certs" —É —Ç–æ–≤–∞—Ä–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ "fasad"
 * –†–µ–∑—É–ª—å—Ç–∞—Ç: JSON-—Ñ–∞–π–ª —Å–æ —Å–ø–∏—Å–∫–æ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
 */

$tvName = 'certs';
// –ö—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º JSON
$outputFile = MODX_BASE_PATH . 'all_certs.json';

// –°–æ–±–∏—Ä–∞–µ–º –ø—É—Ç–∏
$files = [];

$products = $modx->getCollection('msProduct', ['context_key' => 'fasad']);
foreach ($products as $product) {
    $certs = $product->getTVValue($tvName);
    if (empty($certs)) continue;

    $certsArray = json_decode($certs, true);
    if (!is_array($certsArray)) continue;

    foreach ($certsArray as $item) {
        if (!empty($item['file'])) {
            $files[] = $item['file'];
        }
    }
}

// –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
$files = array_values(array_unique($files));
sort($files);

// –°–æ—Ö—Ä–∞–Ω—è–µ–º JSON
$json = json_encode($files, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
file_put_contents($outputFile, $json);

```

</details>

### üîµ –°–ö–†–ò–ü–¢ 2 ‚Äî –ù–û–í–´–ô –°–ê–ô–¢

–°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∏–∑ JSON-–º–∞—Å—Å–∏–≤–∞.

<details>
<summary>–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</summary>

```php
<?php

/**
 * –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∏–∑ JSON-–º–∞—Å—Å–∏–≤–∞
 */

// JSON-–º–∞—Å—Å–∏–≤ –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ø—Ä—è–º–æ —Å—é–¥–∞
$json = '[
  "http://www-fasad.ru/assets/template/img/import//krovlyaspb/fasadnye_paneli_gl.pdf",

]';

$files = json_decode($json, true);

// –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–∞–ø–∫–∞
$savePath = MODX_BASE_PATH . 'assets/documents/certificates/';

// –°–æ–∑–¥–∞–¥–∏–º –ø–∞–ø–∫—É –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
if (!is_dir($savePath)) {
    mkdir($savePath, 0755, true);
}

foreach ($files as $file) {
    $url = $file;
    $filename = basename($file);
    $localFile = $savePath . $filename;


    // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
    $data = @file_get_contents($url);
    if ($data === false) {
        continue;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
    file_put_contents($localFile, $data);
}

```

</details>

