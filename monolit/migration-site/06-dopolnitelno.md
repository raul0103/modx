# 6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ ID –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –∞–∫—Ç—É–∞–ª–µ–Ω **—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ ID —Ä–µ—Å—É—Ä—Å–æ–≤ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å** –ø–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞. –ï—Å–ª–∏ ID –æ—Å—Ç–∞–ª–∏—Å—å –ø—Ä–µ–∂–Ω–∏–º–∏, —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.

## –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç—ã –∏–∑ —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞, –µ—Å–ª–∏:
- –í—ã –ø–µ—Ä–µ–Ω–æ—Å–∏–ª–∏ —Å–∞–π—Ç —á–µ—Ä–µ–∑ CLONER –∏ ID —Ä–µ—Å—É—Ä—Å–æ–≤ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
- –í —Ç–∞–±–ª–∏—Ü–∞—Ö `modx_products_composer_selection` –∏ `modx_ss_rules` –æ—Å—Ç–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–µ ID
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ä–µ—Å—É—Ä—Å–∞–º–∏

–ï—Å–ª–∏ ID –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –ø—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—ã —Å –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª.

---

## –î–∞–Ω–Ω—ã–µ –¥–ª—è msProductsComposerSelection –∏ modx_ss_rules

–ï—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è ID –Ω–∞ —Å–∞–π—Ç–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã.

> ‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –° –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ —Å–∞–π—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–æ–≤—ã–π –≤—Å—é —Ç–∞–±–ª–∏—Ü—É `modx_products_composer_selection` –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Å–∫—Ä–∏–ø—Ç–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

### üü¢ –°–ö–†–ò–ü–¢ 1 ‚Äî –î–û–ù–û–†

–ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ –¥–æ–Ω–æ—Ä–µ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–∏. –°–æ–∑–¥–∞–µ—Ç JSON-—Ñ–∞–π–ª —Å –º–∞–ø–ø–∏–Ω–≥–æ–º —Å—Ç–∞—Ä—ã—Ö ID ‚Üí URI.

<details>
<summary>–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</summary>

```php
 <?php
  /**
  * DONOR SCRIPT
  * –°–æ–±–∏—Ä–∞–µ—Ç:
  * 1. rid ‚Üí uri
  * 2. parent IDs ‚Üí uri
  */

  $context = 'fasad';
  $file = MODX_BASE_PATH . 'ms_products_composer_map.json';

  /* =========================
  * RID (msCategory)
  * ========================= */
  $categories = $modx->getCollection('modResource', [
      'context_key' => $context,
      'class_key'   => 'msCategory'
  ]);

  $rid = [];
  foreach ($categories as $cat) {
      $rid[$cat->id] = $cat->uri;
  }

  /* =========================
  * PARENT
  * ========================= */
  $res = $modx->query("
      SELECT val
      FROM modx_products_composer_selection
      WHERE `key` = 'parent'
  ");

  $parentsIds = [];
  foreach ($res->fetchAll(PDO::FETCH_ASSOC) as $row) {
      $parentsIds = array_merge($parentsIds, explode(',', $row['val']));
  }

  $parentsIds = array_unique(array_filter($parentsIds));

  $parentsResources = $modx->getCollection('modResource', [
      'id:in' => $parentsIds
  ]);

  $parents = [];
  foreach ($parentsResources as $res) {
      $parents[$res->id] = $res->uri;
  }

  /* =========================
  * SAVE
  * ========================= */
  $data = [
      'rid'    => $rid,
      'parent' => $parents
  ];

  file_put_contents($file, json_encode($data, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));

  echo 'DONOR: success';

```

</details>

### üîµ –°–ö–†–ò–ü–¢ 2 ‚Äî –ù–û–í–´–ô –°–ê–ô–¢

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ `modx_products_composer_selection` –Ω–∞ –Ω–æ–≤–æ–º —Å–∞–π—Ç–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç URI –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∏ –Ω–æ–≤—ã—Ö ID.

<details>
<summary>–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</summary>

```php
<?php
/**
 * TARGET SCRIPT
 * –û–±–Ω–æ–≤–ª—è–µ—Ç:
 * 1. rid
 * 2. parent
 */

$file = MODX_BASE_PATH . 'ms_products_composer_map.json';
$data = json_decode(file_get_contents($file), true);

if (!$data) {
    exit('JSON not found or invalid');
}

/* =========================
 * UPDATE RID
 * ========================= */
foreach ($data['rid'] as $oldId => $uri) {

    $resource = $modx->getObject('modResource', ['uri' => $uri]);
    if (!$resource) {
        continue;
    }

    $newId = $resource->id;

    $modx->query("
        UPDATE modx_products_composer_selection
        SET rid = {$newId}
        WHERE rid = {$oldId}
    ");
}

/* =========================
 * UPDATE PARENT
 * ========================= */
$res = $modx->query("
    SELECT id, val
    FROM modx_products_composer_selection
    WHERE `key` = 'parent'
");

$rows = $res->fetchAll(PDO::FETCH_ASSOC);

foreach ($rows as $row) {

    $parents = explode(',', $row['val']);
    $newParents = [];

    foreach ($parents as $oldParentId) {

        if (!isset($data['parent'][$oldParentId])) {
            continue;
        }

        $uri = $data['parent'][$oldParentId];
        $resource = $modx->getObject('modResource', ['uri' => $uri]);

        if ($resource) {
            $newParents[] = $resource->id;
        }
    }

    if (!empty($newParents)) {
        $ids = implode(',', array_unique($newParents));

        $modx->query("
            UPDATE modx_products_composer_selection
            SET val = '{$ids}'
            WHERE id = {$row['id']}
        ");
    }
}

echo 'TARGET: success';
```

</details>

### üîµ –°–ö–†–ò–ü–¢ 3 ‚Äî –ù–û–í–´–ô –°–ê–ô–¢

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–ª–∞–≥–∏–Ω–∞ `modx_ss_rules` (–ø–ª–∞–≥–∏–Ω –≤—ã–≤–æ–¥–∏—Ç "–í–∞–º –º–æ–≥—É—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è" —Ç–∞–±–∞–º–∏ –≤ —Ç–æ–≤–∞—Ä–µ).

<details>
<summary>–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</summary>

```php
<?php
/**
 * UPDATE modx_ss_rules.categories
 * old_id ‚Üí uri ‚Üí new_id
 */

$file = MODX_BASE_PATH . 'ms_products_composer_map.json';
$data = json_decode(file_get_contents($file), true);

if (!$data || empty($data['rid'])) {
    exit('Mapping file not found or invalid');
}

/* =========================
 * LOAD RULES
 * ========================= */
$res = $modx->query("
    SELECT id, categories
    FROM modx_ss_rules
    WHERE categories IS NOT NULL
      AND categories != ''
");

$rows = $res->fetchAll(PDO::FETCH_ASSOC);

/* =========================
 * UPDATE
 * ========================= */
foreach ($rows as $row) {

    $oldIds = explode(',', $row['categories']);
    $newIds = [];

    foreach ($oldIds as $oldId) {
        $oldId = trim($oldId);

        // old_id ‚Üí uri
        if (!isset($data['rid'][$oldId])) {
            continue;
        }

        $uri = $data['rid'][$oldId];

        // uri ‚Üí new_id
        $resource = $modx->getObject('modResource', ['uri' => $uri]);
        if ($resource) {
            $newIds[] = $resource->id;
        }
    }

    if (!empty($newIds)) {

        $newIds = implode(',', array_unique($newIds));

        $modx->query("
            UPDATE modx_ss_rules
            SET categories = '{$newIds}'
            WHERE id = {$row['id']}
        ");
    }
}

echo 'SS RULES: success';
```

</details>

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

- [ ] –¢–∞–±–ª–∏—Ü–∞ `modx_products_composer_selection` —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ ID
- [ ] –¢–∞–±–ª–∏—Ü–∞ `modx_ss_rules` —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ ID –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- [ ] –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª "–í–∞–º –º–æ–≥—É—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è" —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –í—Å–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ä–µ—Å—É—Ä—Å–∞–º–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
