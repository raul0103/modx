# –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: CategoryProductRules

## –û–ø–∏—Å–∞–Ω–∏–µ

–í—ã–±–æ—Ä–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –Ω–µ–±–æ–ª—å—à–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö, –ø–æ—Ö–æ–∂–∏–µ —Ç–æ–≤–∞—Ä—ã.
–£—Å–ª–æ–≤–∏—è –≤—ã–±–æ—Ä–æ–∫ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
components/
‚îî‚îÄ‚îÄ CategoryProductRules/
    ‚îú‚îÄ‚îÄ app/            # –ò—Å—Ö–æ–¥–Ω–∏–∫–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (React + Vite)
    ‚îú‚îÄ‚îÄ controllers/    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –∞–¥–º–∏–Ω–∫–µ MODX
    ‚îú‚îÄ‚îÄ actions/        # –≠–∫—à–µ–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –±–∞–∑–µ
        ‚îî‚îÄ‚îÄ mgr         # –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ mgr –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        ‚îî‚îÄ‚îÄ web
    ‚îú‚îÄ‚îÄ templates/      # –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–∞ (index.html, assets)
    ‚îî‚îÄ‚îÄ action.php      # API-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞
```

---

## üöÄ Production

1. –î–ª—è –¥–µ–ø–ª–æ—è –∑–∞–ª–µ–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥ –≤ `{core_path}components/CategoryProductRules/`
2. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–ø–∏—Å–∏ –≤ "–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º–µ–Ω"

```code
–ù–∞–∑–≤–∞–Ω–∏–µ
CategoryProductRules

–ü—É—Ç—å –∫ —è–¥—Ä—É
{core_path}components/CategoryProductRules/

–ü—É—Ç—å –∫ –∞–∫—Ç–∏–≤–∞–º
{assets_path}components/CategoryProductRules/
```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤ action.php `const PRODUCTION = true;`
4. –° app/ –∑–∞–ø—É—Å—Ç–∏—Ç—å `npm run build` - –í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã –ø–æ–ø–∞–¥—É—Ç –≤ assets/components/CategoryProductRules
5. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ `database/migrations/table_name.php` (–ü–æ–∫–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å. –ù–µ –ø—Ä–∏–¥—É–º–∞–ª –∫–∞–∫ —É–ø—Ä–æ—Å—Ç–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É)

–ï—Å–ª–∏ –±—É–¥—É—Ç –æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–µ—Ä—å app/.env.production

---

## –í—ã–≤–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ

1. –°–æ–∑–¥–∞–µ–º —Å–Ω–∏–ø–ø–µ—Ç getRules.php

```php
<?php

$category_id = $modx->resource->id;
$table_prefix = $modx->getOption('table_prefix');

try {
    $res = $modx->query("SELECT * FROM {$table_prefix}catprod_rules WHERE category_id = $category_id");
    $data = $res->fetch(PDO::FETCH_ASSOC);

    if ($data) {
        $rules = json_decode($data['rules'], true);
        return [
            'parents' => implode(',', $rules['parents']),
            'options' => str_replace(["{", "}"], ["{ ", " }"], json_encode($rules['options'], JSON_UNESCAPED_UNICODE))
        ];
    } else {
        return null;
    }
} catch (Exception $e) {
}

```

2. –í—ã–≤–æ–¥–∏–º –≤ —á–∞–Ω–∫–µ

```php
{if $rules = "@FILE _modules/category-product-rules/snippets/getRules.php" | snippet}
  <div>
    {'msProducts' | snippet : [
        'parents' => $rules['parents'],
        'optionFilters' => $rules['options'],
        'tpl' => '@FILE chunks/product/listing-products-item-slide.tpl',
        'tplWrapper' => '@INLINE {$output}',
        'includeTVs' => 'isFractional,productNotAvailable,freeShipping',
        'includeThumbs' => 'webp',
    ]}
  </div>
{/if}
```

---

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∞–¥–º–∏–Ω–∫–∞ (`app/`)

```bash
cd app/
npm install         # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm run dev         # –ó–∞–ø—É—Å–∫ dev-—Å–µ—Ä–≤–µ—Ä–∞ (Vite)
npm run build       # –°–±–æ—Ä–∫–∞ production-–≤–µ—Ä—Å–∏–∏ –≤ ../templates/
```

### –ë—ç–∫–µ–Ω–¥

- `action.php` –î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –±–∞–∑—É —É—Å—Ç–∞–Ω–æ–≤–∏
  `const PRODUCTION = false;`

  **‚ö†Ô∏è –ù–ï –ó–ê–ë–£–î–¨ –í–ï–†–ù–£–¢–¨ –û–ë–†–ê–¢–ù–û –ù–ê TRUE –ü–†–ò –î–ï–ü–õ–û–ï!**

---
